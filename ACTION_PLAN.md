# üéØ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ –£–Ø–ó–í–ò–ú–û–°–¢–ï–ô

## üìÖ ROADMAP

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –î–ï–ù–¨ 1-2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (C1, C2, C7)            ‚îÇ
‚îÇ  ‚îú‚îÄ Race Condition                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Auto Rollback                                           ‚îÇ
‚îÇ  ‚îî‚îÄ Double Spend Protection                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –î–ï–ù–¨ 3-5: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (C3, C4, C5, C6)                   ‚îÇ
‚îÇ  ‚îú‚îÄ Memory Leak Fix                                         ‚îÇ
‚îÇ  ‚îú‚îÄ Telegram Queue                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Input Validation                                        ‚îÇ
‚îÇ  ‚îî‚îÄ WebSocket Reconnection                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –ù–ï–î–ï–õ–Ø 2: –í—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏ (H1-H8)                           ‚îÇ
‚îÇ  ‚îú‚îÄ WebSocket Timeouts                                      ‚îÇ
‚îÇ  ‚îú‚îÄ Lighter Verification                                    ‚îÇ
‚îÇ  ‚îú‚îÄ BP Validation                                           ‚îÇ
‚îÇ  ‚îî‚îÄ Logging & Monitoring                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –ù–ï–î–ï–õ–Ø 3-4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥                     ‚îÇ
‚îÇ  ‚îú‚îÄ Integration Tests                                       ‚îÇ
‚îÇ  ‚îú‚îÄ Load Testing                                            ‚îÇ
‚îÇ  ‚îú‚îÄ Monitoring Setup                                        ‚îÇ
‚îÇ  ‚îî‚îÄ Documentation                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üö® –î–ï–ù–¨ 1-2: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ –ó–∞–¥–∞—á–∞ 1: Race Condition (2 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å `src/modules/auto_trade/auto_trade.session.ts`
2. –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É 163 (–Ω–∞—á–∞–ª–æ –±–ª–æ–∫–∞ —Ç—Ä–µ–π–¥–∞)
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ `CRITICAL_FIXES.md` ‚Üí –†–∞–∑–¥–µ–ª "C1"
4. –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 163-174
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

**–¢–µ—Å—Ç:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
# –°—Ä–∞–∑—É –Ω–∞–∂–∞—Ç—å "OPEN POS"
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–∞. –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."
# –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚ö†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ –≤—Ä–µ–º—è —Å–¥–µ–ª–∫–∏!"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 2: Auto Rollback (3 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`

**–®–∞–≥–∏:**
1. –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É 176 (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤)
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ `CRITICAL_FIXES.md` ‚Üí –†–∞–∑–¥–µ–ª "C2"
3. –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 176-185
4. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ rollback –æ–ø–µ—Ä–∞—Ü–∏–π

**–¢–µ—Å—Ç:**
```bash
# –°–∏–º—É–ª—è—Ü–∏—è: –û—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ SHORT –±–∏—Ä–∂–µ
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
# LONG –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç—å—Å—è, SHORT —É–ø–∞—Å—Ç—å
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ LONG
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ –ù–µ—Ç –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 3: Double Spend Protection (1 —á–∞—Å)
**–§–∞–π–ª—ã:** `auto_trade.controller.ts`

**–®–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `processingUsers` –≤ –∫–ª–∞—Å—Å (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 31)
2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `handleOpenPosCommand` (—Å—Ç—Ä–æ–∫–∞ 74)
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ `CRITICAL_FIXES.md` ‚Üí –†–∞–∑–¥–µ–ª "C7"

**–¢–µ—Å—Ç:**
```bash
# –ë—ã—Å—Ç—Ä–æ –Ω–∞–∂–∞—Ç—å "OPEN POS" 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –¢–æ–ª—å–∫–æ 1 —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä"
# –û—Å—Ç–∞–ª—å–Ω—ã–µ: "‚è≥ –ö–æ–º–∞–Ω–¥–∞ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Å–µ—Å—Å–∏–π

---

## ‚ö° –î–ï–ù–¨ 3-5: –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨

### ‚úÖ –ó–∞–¥–∞—á–∞ 4: Memory Leak Fix (2 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.controller.ts`, `bp.controller.ts`

**–®–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å `userStateTimestamps` Map
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `cleanupStaleStates()`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å cleanup –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
4. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è states

**–¢–µ—Å—Ç:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
# –°–æ–∑–¥–∞—Ç—å 100 "–º–µ—Ä—Ç–≤—ã—Ö" states (–Ω–∞—á–∞—Ç—å flow –∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å)
# –ü–æ–¥–æ–∂–¥–∞—Ç—å 11 –º–∏–Ω—É—Ç
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: node -e "console.log(process.memoryUsage())"
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: Memory usage —Å—Ç–∞–±–∏–ª—å–Ω–∞
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ Memory usage –Ω–µ —Ä–∞—Å—Ç–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 5: Telegram Queue (3 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** –ù–æ–≤—ã–π `src/common/telegram.queue.ts`, `auto_trade.controller.ts`

**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `telegram.queue.ts`
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ `CRITICAL_FIXES.md` ‚Üí –†–∞–∑–¥–µ–ª "C4"
3. –ó–∞–º–µ–Ω–∏—Ç—å `enqueueMessage` –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
4. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ `processQueue`

**–¢–µ—Å—Ç:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π
# –ö–∞–∂–¥–∞—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
# –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å Telegram API responses
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ù–µ—Ç 429 –æ—à–∏–±–æ–∫
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ –ù–µ—Ç rate limit –æ—à–∏–±–æ–∫ –ø—Ä–∏ 10+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 6: Input Validation (1 —á–∞—Å)
**–§–∞–π–ª—ã:** `auto_trade.controller.ts`

**–®–∞–≥–∏:**
1. –ù–∞–π—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É `total_qty` (—Å—Ç—Ä–æ–∫–∞ 122)
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–º–∞
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `MAX_SAFE_QTY` –ø–æ–¥ —Å–≤–æ–π –¥–µ–ø–æ–∑–∏—Ç

**–¢–µ—Å—Ç:**
```bash
# –í–≤–µ—Å—Ç–∏ totalQty = 999999
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "‚ùå –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –æ–±—ä–µ–º!"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –æ–ø–∞—Å–Ω—ã–π –æ–±—ä–µ–º

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 7: WebSocket Reconnection (4 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`

**–®–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `waitingForPricesCount`
2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Ü–µ–Ω (—Å—Ç—Ä–æ–∫–∞ 121)
3. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ `CRITICAL_FIXES.md` ‚Üí –†–∞–∑–¥–µ–ª "C6"

**–¢–µ—Å—Ç:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
# –°–∏–º—É–ª—è—Ü–∏—è: –û—Ç–∫–ª—é—á–∏—Ç—å WebSocket –Ω–∞ –±–∏—Ä–∂–µ (firewall rule)
# –ü–æ–¥–æ–∂–¥–∞—Ç—å 65 —Å–µ–∫—É–Ω–¥
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "‚ùå –ù–µ—Ç —Ü–µ–Ω 60 —Å–µ–∫. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ WebSocket..."
# –ó–∞—Ç–µ–º: "‚úÖ WebSocket –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤

---

## üìä –ù–ï–î–ï–õ–Ø 2: –í–´–°–û–ö–ò–ï –†–ò–°–ö–ò

### ‚úÖ –ó–∞–¥–∞—á–∞ 8: WebSocket Timeouts (2 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `bp.session.ts`

**–ö–æ–¥:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å BpSession
private lastPriceUpdate = Date.now();

// –í callback WebSocket:
this.latestLongAsk = parseFloat(ask);
this.lastPriceUpdate = Date.now(); // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è

// –í calculationInterval:
if (Date.now() - this.lastPriceUpdate > 30000) {
    callback(null);
    throw new Error('No price updates for 30 sec');
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 9: Lighter Verification (3 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.helpers.ts`

**–ö–æ–¥:**
```typescript
// –í executeTrade –¥–ª—è Lighter (—Å—Ç—Ä–æ–∫–∞ 252)
if (exchange === 'Lighter') {
    const res = await services.lighter.placeOrder(symbol, side, qty, 'MARKET');
    
    // –ï—Å–ª–∏ ASSUMED_FILLED, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é
    if (res.status === 'ASSUMED_FILLED') {
        await sleep(2000);
        const position = await getPositionData('Lighter', coin, services);
        
        if (position.size >= qty * 0.95) { // 95% –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
            return { success: true, price: position.price };
        }
        
        return {
            success: false,
            error: `Lighter: Position not confirmed. Expected ${qty}, got ${position.size}`
        };
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 10: BP Validation (1 —á–∞—Å)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`

**–ö–æ–¥:**
```typescript
// –ü–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ BP (—Å—Ç—Ä–æ–∫–∞ 135)
const currentMarketBp = ((this.currentShortBid - this.currentLongAsk) / this.currentShortBid) * 10000;

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π BP
if (currentMarketBp > targetBp + 50) {
    await onUpdate(`‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π BP: ${currentMarketBp.toFixed(1)}. –ü—Ä–æ–ø—É—Å–∫.`);
    this.stepTimeout = setTimeout(() => this.runStep(), 1000);
    return;
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π BP
if (currentMarketBp < -100) {
    await onUpdate(`‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (BP: ${currentMarketBp.toFixed(1)}). –ü—Ä–æ–ø—É—Å–∫.`);
    this.stepTimeout = setTimeout(() => this.runStep(), 1000);
    return;
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 11: Session Timeout (1 —á–∞—Å)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`

**–ö–æ–¥:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å
private sessionStartTime = Date.now();
private readonly MAX_SESSION_DURATION = 3600_000; // 1 —á–∞—Å

// –í –Ω–∞—á–∞–ª–µ runStep()
if (Date.now() - this.sessionStartTime > this.MAX_SESSION_DURATION) {
    await onUpdate('‚è∞ –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏ (1 —á–∞—Å). –û—Å—Ç–∞–Ω–æ–≤–∫–∞.');
    this.stop('Session timeout');
    this.config.onFinished();
    return;
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 12: Min Order Size Check (2 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`, —Å–æ–∑–¥–∞—Ç—å `exchange.limits.ts`

**–ö–æ–¥:**
```typescript
// –°–æ–∑–¥–∞—Ç—å src/common/exchange.limits.ts
export const MIN_ORDER_SIZES = {
    'Binance': { 'BTC': 0.001, 'ETH': 0.01, 'DEFAULT': 1 },
    'Hyperliquid': { 'DEFAULT': 0.1 },
    'Paradex': { 'DEFAULT': 0.1 },
    'Extended': { 'DEFAULT': 0.1 },
    'Lighter': { 'DEFAULT': 0.1 }
};

export function getMinOrderSize(exchange: string, coin: string): number {
    const limits = MIN_ORDER_SIZES[exchange];
    return limits?.[coin] || limits?.['DEFAULT'] || 0.1;
}

// –í auto_trade.session.ts (–ø–µ—Ä–µ–¥ executeTrade)
import { getMinOrderSize } from '../../common/exchange.limits';

const minLongSize = getMinOrderSize(this.config.longExchange, this.config.coin);
const minShortSize = getMinOrderSize(this.config.shortExchange, this.config.coin);
const minSize = Math.max(minLongSize, minShortSize);

if (qtyToTrade < minSize) {
    await onUpdate(`‚ö†Ô∏è –û–±—ä–µ–º ${qtyToTrade} < –º–∏–Ω–∏–º—É–º ${minSize}. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.`);
    await this.finishTrade();
    return;
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 13: Logging System (3 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** –ù–æ–≤—ã–π `src/common/logger.ts`, –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

**–ö–æ–¥:**
```typescript
// src/common/logger.ts
import winston from 'winston';
import path from 'path';

const logDir = path.join(__dirname, '../../logs');

export const logger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
    ),
    transports: [
        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
        new winston.transports.File({ 
            filename: path.join(logDir, 'critical.log'),
            level: 'error'
        }),
        // –í—Å–µ —Ç—Ä–µ–π–¥—ã
        new winston.transports.File({ 
            filename: path.join(logDir, 'trades.log'),
            level: 'info'
        }),
        // Console –¥–ª—è dev
        new winston.transports.Console({
            format: winston.format.simple()
        })
    ]
});

// –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
export function logTrade(data: {
    userId: number;
    coin: string;
    longExchange: string;
    shortExchange: string;
    qty: number;
    longPrice?: number;
    shortPrice?: number;
    success: boolean;
    error?: string;
}) {
    logger.info('TRADE', data);
}

export function logCritical(event: string, data: any) {
    logger.error('CRITICAL', { event, ...data, timestamp: new Date().toISOString() });
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ auto_trade.session.ts:**
```typescript
import { logTrade, logCritical } from '../../common/logger';

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∞ (—Å—Ç—Ä–æ–∫–∞ 188)
logTrade({
    userId: this.config.userId,
    coin: this.config.coin,
    longExchange: this.config.longExchange,
    shortExchange: this.config.shortExchange,
    qty: qtyToTrade,
    longPrice: longRes.price,
    shortPrice: shortRes.price,
    success: true
});

// –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ (—Å—Ç—Ä–æ–∫–∞ 178)
logCritical('CRITICAL_LEG_FAILURE', {
    userId: this.config.userId,
    coin: this.config.coin,
    longExchange: this.config.longExchange,
    shortExchange: this.config.shortExchange,
    longResult: longRes,
    shortResult: shortRes
});
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 14: BP Service Error Handling (1 —á–∞—Å)
**–§–∞–π–ª—ã:** `bp.controller.ts`

**–ö–æ–¥:**
```typescript
// –í –º–µ—Ç–æ–¥–µ startSession (—Å—Ç—Ä–æ–∫–∞ 165)
try {
    await this.bpService.startSession(
        userId,
        state.coin,
        state.longExchange,
        state.shortExchange,
        onUpdate
    );
} catch (e: any) {
    // ‚úÖ –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê
    this.userState.delete(userId);
    this.userStateTimestamps.delete(userId);
    this.bpService.stopSession(userId);
    
    if (state.messageId) {
        try {
            await ctx.telegram.editMessageText(
                userId, 
                state.messageId, 
                undefined, 
                `‚ùå –û—à–∏–±–∫–∞: ${e.message}`
            );
        } catch { }
    }
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 15: Price Smoothing (2 —á–∞—Å–∞)
**–§–∞–π–ª—ã:** `auto_trade.session.ts`

**–ö–æ–¥:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å
private bpHistory: number[] = [];

// –í runStep(), –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ BP (—Å—Ç—Ä–æ–∫–∞ 135)
const instantBp = ((this.currentShortBid - this.currentLongAsk) / this.currentShortBid) * 10000;

// –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
this.bpHistory.push(instantBp);
if (this.bpHistory.length > 5) {
    this.bpHistory.shift(); // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–Ω–∞—á–µ–Ω–∏–π
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
const currentMarketBp = this.bpHistory.reduce((a, b) => a + b, 0) / this.bpHistory.length;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è
if (onStatusUpdate) {
    await onStatusUpdate({
        filledQty: this.filledQuantity,
        totalQty: totalQuantity,
        longAsk: this.currentLongAsk,
        shortBid: this.currentShortBid,
        currentBp: currentMarketBp,
        instantBp: instantBp, // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        status: currentMarketBp < targetBp ? 'WAITING_BP' : 'TRADING'
    });
}
```

---

## üß™ –ù–ï–î–ï–õ–Ø 3: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### ‚úÖ –ó–∞–¥–∞—á–∞ 16: Integration Tests (8 —á–∞—Å–æ–≤)

**–°–æ–∑–¥–∞—Ç—å:** `tests/integration/auto_trade.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';
import { AutoTradeService } from '../../src/modules/auto_trade/auto_trade.service';

describe('AutoTrade Integration Tests', () => {
    let service: AutoTradeService;
    
    beforeEach(() => {
        service = new AutoTradeService(/* mock dependencies */);
    });
    
    afterEach(async () => {
        // Cleanup
    });
    
    it('should prevent race condition on stop', async () => {
        // Test C1 fix
    });
    
    it('should rollback on partial fill', async () => {
        // Test C2 fix
    });
    
    it('should prevent double spend', async () => {
        // Test C7 fix
    });
    
    it('should cleanup stale states', async () => {
        // Test C3 fix
    });
    
    it('should respect rate limits', async () => {
        // Test C4 fix
    });
    
    it('should validate input', async () => {
        // Test C5 fix
    });
    
    it('should reconnect websocket', async () => {
        // Test C6 fix
    });
});
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 17: Load Testing (4 —á–∞—Å–∞)

**–°–æ–∑–¥–∞—Ç—å:** `tests/load/stress.test.ts`

```typescript
// –°–∏–º—É–ª—è—Ü–∏—è 50 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function stressTest() {
    const users = Array.from({ length: 50 }, (_, i) => i + 1);
    
    await Promise.all(users.map(async (userId) => {
        // –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
        // 1. –ù–∞—á–∏–Ω–∞–µ—Ç flow
        // 2. –í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ
        // 3. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–æ—Ä–≥–æ–≤–ª—é
        // 4. –ü–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        // 5. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
    }));
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∏:
    // - Memory usage < 500MB
    // - No rate limit errors
    // - All sessions cleaned up
}
```

---

## üìà –ù–ï–î–ï–õ–Ø 4: –ú–û–ù–ò–¢–û–†–ò–ù–ì

### ‚úÖ –ó–∞–¥–∞—á–∞ 18: Health Check Endpoint (2 —á–∞—Å–∞)

**–°–æ–∑–¥–∞—Ç—å:** `src/modules/health/health.controller.ts`

```typescript
export class HealthController {
    async getHealth() {
        return {
            status: 'OK',
            timestamp: new Date().toISOString(),
            uptime: process.uptime(),
            memory: process.memoryUsage(),
            activeSessions: this.getActiveSessionCount(),
            websockets: await this.checkWebSockets(),
            exchanges: await this.checkExchanges()
        };
    }
    
    private async checkWebSockets() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    }
    
    private async checkExchanges() {
        // Ping –≤—Å–µ—Ö –±–∏—Ä–∂
    }
}
```

---

### ‚úÖ –ó–∞–¥–∞—á–∞ 19: Alerts System (3 —á–∞—Å–∞)

**–°–æ–∑–¥–∞—Ç—å:** `src/common/alerts.ts`

```typescript
import { Telegraf } from 'telegraf';

const ADMIN_CHAT_ID = process.env.ADMIN_TELEGRAM_ID;
const bot = new Telegraf(process.env.BOT_TOKEN!);

export async function sendAlert(level: 'INFO' | 'WARNING' | 'CRITICAL', message: string) {
    const emoji = {
        'INFO': '‚ÑπÔ∏è',
        'WARNING': '‚ö†Ô∏è',
        'CRITICAL': 'üö®'
    };
    
    await bot.telegram.sendMessage(
        ADMIN_CHAT_ID!,
        `${emoji[level]} <b>${level}</b>\n\n${message}`,
        { parse_mode: 'HTML' }
    );
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
// await sendAlert('CRITICAL', 'Memory usage > 80%');
// await sendAlert('WARNING', 'WebSocket reconnected 3 times');
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò –ö –ü–†–û–î–ê–ö–®–ï–ù–£

```
–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
‚òê C1: Race Condition
‚òê C2: Auto Rollback
‚òê C3: Memory Leak
‚òê C4: Telegram Rate Limit
‚òê C5: Input Validation
‚òê C6: WebSocket Reconnection
‚òê C7: Double Spend

–í–´–°–û–ö–ò–ï –†–ò–°–ö–ò:
‚òê H1: WebSocket Timeouts
‚òê H2: Lighter Verification
‚òê H3: BP Validation
‚òê H4: Session Timeout
‚òê H5: Price Smoothing
‚òê H6: Min Order Size
‚òê H7: Logging
‚òê H8: BP Error Handling

–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:
‚òê Unit Tests (80%+ coverage)
‚òê Integration Tests
‚òê Load Tests (50+ users)
‚òê Testnet Testing (1 week)

–ú–û–ù–ò–¢–û–†–ò–ù–ì:
‚òê Health Check
‚òê Alerts System
‚òê Logging
‚òê Metrics Dashboard

–î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø:
‚òê API Documentation
‚òê Deployment Guide
‚òê Troubleshooting Guide
‚òê User Manual
```

---

## üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–Ω—å–≥–∞—Ö:

1. ‚úÖ –í—Å–µ —á–µ–∫–ª–∏—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
2. ‚úÖ Testnet —Ä–∞–±–æ—Ç–∞–µ—Ç 7+ –¥–Ω–µ–π –±–µ–∑ –æ—à–∏–±–æ–∫
3. ‚úÖ Load test –ø—Ä–æ–π–¥–µ–Ω (50+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
4. ‚úÖ Memory leak test –ø—Ä–æ–π–¥–µ–Ω (24+ —á–∞—Å–∞)
5. ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
6. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
7. ‚úÖ –ï—Å—Ç—å –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ (rollback plan)
8. ‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º

---

**–£–¥–∞—á–∏! üöÄ**
